#!/bin/bash
[[ -e /var/run/dbus.pid ]] && gosu root rm -f /var/run/dbus.pid
[[ -e /var/run/avahi-daemon/pid ]] && gosu root rm -f /var/run/avahi-daemon/pid
[[ -e /var/run/dbus/system_bus_socket ]] && gosu root rm -f /var/run/dbus/system_bus_socket

gosu root sed -i "s/#enable-dbus=yes/enable-dbus=yes/g" /etc/avahi/avahi-daemon.conf && gosu root sed -i "s/.*host-name.*/host-name=$HOST_NAME/" /etc/avahi/avahi-daemon.conf

echo "Starting dbus-daemon"
gosu root service dbus restart

until [ -e /var/run/dbus/system_bus_socket ]; do
  sleep 1s
done

echo "Starting Avahi daemon"
gosu root service avahi-daemon restart

npm start -- --userDir /data
