sudo: 'required'

services:
  - 'docker'

language:
  - 'bash'

env:
  global:
    - BASE_IMAGE_NODE_RED_VERSION=0.18.5-8
    - IMAGE=raymondmm/node-red-homekit
    - QEMU_VERSION=v2.11.1
    - NODE_RED_VERSION=x.y.z
    - NODE_RED_HOMEKIT_VERSION=x.y.z

before_install:
  - . ./update_version.sh
  - ./.docker/docker.sh prepare
  - echo "$NODE_RED_VERSION - $NODE_RED_HOMEKIT_VERSION"
  - ./.docker/docker.sh build

script:
  - ./.docker/docker.sh test

after_success:
  - >
    if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
      # Docker Login
      echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

      # Tag all images
      ./.docker/docker.sh tag

      # Push all images
      ./.docker/docker.sh push

      # Create and push manifest list
      ./.docker/docker.sh manifest-list

      # Docker Logout
      docker logout
    fi

# notify me when things fail
notifications:
    email: true
